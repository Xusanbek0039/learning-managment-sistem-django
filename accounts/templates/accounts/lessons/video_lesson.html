{% extends 'accounts/base.html' %}

{% block title %}{{ lesson.title }} - LMS | IT Creative{% endblock %}

{% block extra_css %}
<style>
:root{
    --card-bg: var(--bs-body-bg);
    --card-border: var(--bs-border-color);
    --soft-bg: rgba(0,0,0,.06);
}
[data-bs-theme="dark"]{ --soft-bg: rgba(255,255,255,.06); }

.card{ background: var(--card-bg); border:1px solid var(--card-border); }

.video-timer{
    background:linear-gradient(135deg,#6c757d,#495057);
    color:#fff;padding:14px 22px;border-radius:14px;
    font-size:1rem;font-weight:600;display:inline-flex;align-items:center;gap:10px;
}
.video-timer.ready{ background:linear-gradient(135deg,#198754,#157347); }
.video-timer.paused{ background:linear-gradient(135deg,#fd7e14,#e85d04); }

.progress-bar-custom{
    height:8px;border-radius:4px;background:var(--soft-bg);
    overflow:hidden;margin-top:15px;
}
.progress-bar-fill{
    height:100%;background:linear-gradient(135deg,#0d6efd,#0a58ca);
    transition:width .4s linear;
}
.btn-watch{ width:100%;max-width:320px; }

@media(max-width:576px){
    .video-timer{ font-size:.95rem;padding:12px 16px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4 my-md-5">

<a href="{% url 'profession_detail' profession.pk %}" class="btn btn-outline-secondary mb-4">
    <i class="bi bi-arrow-left me-2"></i>Orqaga
</a>

<div class="card shadow-sm">
<div class="card-header bg-transparent border-bottom">
<div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
<h5 class="m-0 text-primary">
<i class="bi bi-play-circle me-2"></i>{{ lesson.title }}
</h5>
{% if progress.watched %}
<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Koâ€˜rilgan</span>
{% endif %}
</div>
</div>

<div class="card-body">

<!-- ================= VIDEO ================= -->
<div class="ratio ratio-16x9 mb-4 rounded overflow-hidden position-relative">

    <!-- Thumbnail -->
    <div id="thumbLayer"
         class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center"
         style="cursor:pointer; z-index:2; background:#000;">
        <img src="https://img.youtube.com/vi/{{ video.get_embed_url|cut:'https://www.youtube.com/embed/' }}/hqdefault.jpg"
             class="w-100 h-100 object-fit-cover" alt="Video">
        <div class="position-absolute text-white fs-1">
            <i class="bi bi-play-circle-fill"></i>
        </div>
    </div>

    <!-- YouTube Player -->
    <div id="player" class="w-100 h-100"></div>

</div>
<!-- ======================================= -->

{% if not progress.watched %}
<div class="text-center">

<div class="mb-4">
<div class="video-timer mb-2" id="timerDisplay">
<i class="bi bi-clock"></i>
<span>Qolgan vaqt: <span id="countdown">00:00</span></span>
</div>

<div class="progress-bar-custom mx-auto" style="max-width:400px;">
<div class="progress-bar-fill" id="progressBar" style="width:0%;"></div>
</div>

<p class="text-muted mt-2" id="statusText">
<i class="bi bi-info-circle me-1"></i>
Videoni kamida {% widthratio video.duration 2 1 %} daqiqa koâ€˜ring
</p>
</div>

<button class="btn btn-success btn-lg btn-watch mt-2" id="markWatched" disabled>
<i class="bi bi-check-circle me-2"></i>Koâ€˜rdim (+1 coin)
</button>

</div>
{% else %}
<div class="alert alert-success text-center">
<i class="bi bi-check-circle me-2"></i>
Siz bu videoni koâ€˜rgansiz va 1 coin oldingiz!
</div>
{% endif %}

</div>
</div>
</div>
{% endblock %}

{% block extra_js %}

<script src="https://www.youtube.com/iframe_api"></script>

<script>
{% if not progress.watched %}

const videoMinutes = {{ video.duration|default:1 }};
const requiredTime = Math.floor(videoMinutes * 60 / 2);

let watchedTime = 0;
let timerInterval = null;
let playerReady = false;

const countdownEl = document.getElementById('countdown');
const progressBar = document.getElementById('progressBar');
const timerDisplay = document.getElementById('timerDisplay');
const statusText = document.getElementById('statusText');
const markWatchedBtn = document.getElementById('markWatched');
const thumbLayer = document.getElementById('thumbLayer');

function formatTime(s){
    const m = Math.floor(s/60);
    const ss = s%60;
    return `${m}:${ss.toString().padStart(2,'0')}`;
}
countdownEl.textContent = formatTime(requiredTime);

let player;

function onYouTubeIframeAPIReady(){
    player = new YT.Player('player',{
        videoId: "{{ video.get_embed_url|cut:'https://www.youtube.com/embed/' }}",
        width: '100%',
        height: '100%',
        playerVars:{ rel:0, modestbranding:1 },
        events:{
            onReady: () => { playerReady = true; },
            onStateChange: onPlayerStateChange
        }
    });
}

function startTimer(){
    if(timerInterval) return;
    timerInterval = setInterval(()=>{
        watchedTime++;
        const remain = Math.max(0, requiredTime - watchedTime);
        const progress = Math.min(100, watchedTime/requiredTime*100);

        countdownEl.textContent = formatTime(remain);
        progressBar.style.width = progress + "%";

        if(watchedTime >= requiredTime){
            clearInterval(timerInterval);
            timerDisplay.classList.add('ready');
            timerDisplay.innerHTML = '<i class="bi bi-check-circle"></i><span>Tayyor! Tugmani bosishingiz mumkin</span>';
            statusText.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>Video yetarlicha koâ€˜rildi';
            markWatchedBtn.disabled = false;
        }
    },1000);
}

function stopTimer(){
    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval = null;
        timerDisplay.classList.add('paused');
    }
}

function onPlayerStateChange(event){
    if(event.data === YT.PlayerState.PLAYING){
        thumbLayer.classList.add('d-none');
        timerDisplay.classList.remove('paused');
        startTimer();
    }
    if(event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED){
        stopTimer();
    }
}

thumbLayer.addEventListener('click', ()=>{
    if(playerReady){
        thumbLayer.classList.add('d-none');
        player.playVideo();
    }
});

markWatchedBtn.addEventListener('click', function(){
    if(this.disabled) return;

    fetch('{% url "mark_video_watched" video.pk %}',{
        method:'POST',
        headers:{
            'X-CSRFToken':'{{ csrf_token }}',
            'Content-Type':'application/json'
        }
    }).then(r=>r.json()).then(d=>{
        if(d.success){
            alert("Tabriklaymiz! ðŸŽ‰ 1 coin oldingiz!");
            setTimeout(()=>location.reload(),1500);
        }
    });
});

{% endif %}
</script>
{% endblock %}
