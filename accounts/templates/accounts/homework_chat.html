{% extends 'accounts/base.html' %}
{% block title %}{{ submission.homework.lesson.title }} - Muhokama{% endblock %}
{% block content %}
<style>
:root {
    /* iOS Light Palette */
    --ios-fon: #F2F2F7;
    --ios-karta: #FFFFFF;
    --ios-text: #000000;
    --ios-text-secondary: #8E8E93;
    --ios-blue: #007AFF;
    --ios-green: #34C759;
    --ios-orange: #FF9500;
    --ios-red: #FF3B30;
    --ios-indigo: #5856D6;
    --ios-separator: #C6C6C8;
    --ios-blur-bg: rgba(255, 255, 255, 0.7);
}

[data-bs-theme="dark"] {
    /* iOS Dark Palette */
    --ios-fon: #000000;
    --ios-karta: #1C1C1E;
    --ios-text: #FFFFFF;
    --ios-text-secondary: #8E8E93;
    --ios-blue: #0A84FF;
    --ios-green: #30D158;
    --ios-orange: #FF9F0A;
    --ios-red: #FF453A;
    --ios-indigo: #5E5CE6;
    --ios-separator: #38383A;
    --ios-blur-bg: rgba(28, 28, 30, 0.8);
}

body { background-color: var(--ios-fon); color: var(--ios-text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

.asosiy-konteyner { max-width: 1000px; margin: 0 auto; padding: 20px; }

/* Sahifa strukturasi */
.sahifa-to-ri {
    display: grid;
    grid-template-columns: 1fr 340px;
    gap: 25px;
}
@media (max-width: 992px) { .sahifa-to-ri { grid-template-columns: 1fr; } }

/* iOS Card Style */
.ios-karta {
    background: var(--ios-karta);
    border-radius: 14px;
    border: none;
    margin-bottom: 20px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.karta-sarlavha {
    padding: 15px 20px;
    border-bottom: 0.5px solid var(--ios-separator);
    font-weight: 600;
    font-size: 17px;
}

/* Status Banner */
.holat-paneli {
    padding: 16px 20px;
    border-radius: 14px 14px 0 0;
    display: flex;
    align-items: center;
    gap: 12px;
}
.holat-paneli.pending { background: rgba(255, 149, 0, 0.15); color: var(--ios-orange); }
.holat-paneli.reviewing { background: rgba(0, 122, 255, 0.15); color: var(--ios-blue); }
.holat-paneli.revision { background: rgba(255, 59, 48, 0.15); color: var(--ios-red); }
.holat-paneli.accepted { background: rgba(52, 199, 89, 0.15); color: var(--ios-green); }
.holat-paneli.graded { background: rgba(88, 86, 214, 0.15); color: var(--ios-indigo); }

/* Info List */
.ma-lumot-qatori {
    display: flex;
    flex-direction: column;
    padding: 0 20px;
}
.ma-lumot-element {
    padding: 12px 0;
    border-bottom: 0.5px solid var(--ios-separator);
    display: flex;
    justify-content: space-between;
    font-size: 15px;
}
.ma-lumot-element:last-child { border-bottom: none; }
.ma-lumot-label { color: var(--ios-text-secondary); }

/* Fayl Box */
.fayl-box {
    margin: 15px 20px;
    padding: 12px;
    background: var(--ios-fon);
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.fayl-ikonka {
    width: 40px; height: 40px;
    background: var(--ios-blue);
    color: white;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
}

/* Chat iOS Style */
.chat-konteyner {
    height: 500px;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.xabar-pufagi {
    max-width: 75%;
    padding: 8px 16px;
    border-radius: 18px;
    font-size: 16px;
    line-height: 1.3;
    position: relative;
}
.xabar-mine {
    align-self: flex-end;
    background: var(--ios-blue);
    color: white;
}
.xabar-other {
    align-self: flex-start;
    background: var(--ios-separator);
    color: var(--ios-text);
}
.xabar-vaqti {
    font-size: 11px;
    margin-top: 4px;
    opacity: 0.6;
    display: block;
    text-align: right;
}

/* iOS Input */
.chat-pastki-qism {
    padding: 10px 15px;
    background: var(--ios-blur-bg);
    backdrop-filter: blur(10px);
    border-top: 0.5px solid var(--ios-separator);
}
.chat-input-guruhi {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--ios-karta);
    border: 0.5px solid var(--ios-separator);
    border-radius: 20px;
    padding: 5px 15px;
}
.chat-input-guruhi input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 8px 0;
    color: var(--ios-text);
    outline: none;
}

/* Grade Circle */
.baho-aylanasi {
    width: 70px; height: 70px;
    border: 3px solid var(--ios-indigo);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 15px auto;
    font-weight: 700; font-size: 24px; color: var(--ios-indigo);
}
</style>

<div class="asosiy-konteyner">
    <div class="mb-4 d-flex align-items-center justify-content-between">
        <a href="{% url 'my_homework_list' %}" class="text-decoration-none" style="color: var(--ios-blue);">
            <i class="bi bi-chevron-left"></i> Orqaga
        </a>
        <h5 class="mb-0 fw-bold text-center flex-grow-1">{{ submission.homework.lesson.title }}</h5>
        <div style="width: 50px;"></div> </div>

    <div class="sahifa-to-ri">
        <div>
            <div class="ios-karta overflow-hidden">
                <div class="holat-paneli {{ submission.status }}">
                    <i class="bi {% if submission.status == 'graded' %}bi-star-fill{% else %}bi-info-circle-fill{% endif %} fs-4"></i>
                    <div>
                        <span class="fw-bold d-block">
                            {% if submission.status == 'pending' %}Kutilmoqda{% elif submission.status == 'reviewing' %}Tekshirilmoqda{% elif submission.status == 'revision' %}Qayta ishlash{% elif submission.status == 'accepted' %}Qabul qilindi{% elif submission.status == 'graded' %}Baholandi{% endif %}
                        </span>
                    </div>
                </div>

                <div class="ma-lumot-qatori">
                    <div class="ma-lumot-element">
                        <span class="ma-lumot-label">Sana</span>
                        <span>{{ submission.submitted_at|date:"d.m.Y" }}</span>
                    </div>
                    <div class="ma-lumot-element">
                        <span class="ma-lumot-label">Kurs</span>
                        <span>{{ submission.homework.lesson.profession.name }}</span>
                    </div>
                    <div class="ma-lumot-element">
                        <span class="ma-lumot-label">Urinish</span>
                        <span>{{ submission.version }}-urinish</span>
                    </div>
                </div>

                <div class="fayl-box">
                    <div class="fayl-ikonka"><i class="bi bi-file-earmark-arrow-down"></i></div>
                    <div class="flex-grow-1 overflow-hidden">
                        <div class="text-truncate fw-medium" style="font-size: 14px;">{{ submission.file.name|cut:"homework_submissions/" }}</div>
                        <small class="text-secondary">Yuborilgan fayl</small>
                    </div>
                    <a href="{{ submission.file.url }}" target="_blank" class="btn btn-link text-decoration-none" style="color: var(--ios-blue);">
                        <i class="bi bi-download fs-5"></i>
                    </a>
                </div>

                {% if submission.status == 'graded' %}
                <div class="text-center pb-3">
                    <div class="baho-aylanasi">{{ submission.grade }}</div>
                    <p class="small text-secondary">Sizning natijangiz</p>
                </div>
                {% endif %}
            </div>

            {% if submission.status == 'revision' %}
            <div class="ios-karta p-3 border-top border-danger border-4">
                <h6 class="fw-bold text-danger"><i class="bi bi-arrow-repeat me-1"></i> Qayta topshirish</h6>
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="resubmit">
                    <input type="file" name="new_file" class="form-control mb-2 rounded-3 border-0 bg-light" required>
                    <textarea name="note" class="form-control mb-2 rounded-3 border-0 bg-light" rows="2" placeholder="Tuzatish haqida qisqacha..."></textarea>
                    <button type="submit" class="btn w-100 rounded-3 fw-bold" style="background: var(--ios-red); color: white;">Topshirish</button>
                </form>
            </div>
            {% endif %}

            {% if submission.feedback %}
            <div class="ios-karta p-3">
                <h6 class="fw-bold mb-2">O'qituvchi izohi</h6>
                <p class="mb-0 small text-secondary">{{ submission.feedback }}</p>
            </div>
            {% endif %}
        </div>

        <div class="ios-karta d-flex flex-column overflow-hidden" style="height: 600px;">
            <div class="karta-sarlavha">
                <i class="bi bi-chat-fill me-2" style="color: var(--ios-blue);"></i> Muhokama
            </div>
            
            <div class="chat-konteyner" id="chatMaydoni">
                {% if chat_messages %}
                    {% for msg in chat_messages %}
                    <div class="xabar-pufagi {% if msg.sender == request.user %}xabar-mine{% else %}xabar-other{% endif %}">
                        <div>{{ msg.message }}</div>
                        {% if msg.file %}
                        <a href="{{ msg.file.url }}" target="_blank" class="mt-1 d-block text-white small opacity-75">
                            <i class="bi bi-paperclip"></i> Fayl biriktirilgan
                        </a>
                        {% endif %}
                        <span class="xabar-vaqti">{{ msg.created_at|date:"H:i" }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5 opacity-25">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p class="small mt-2">Xabarlar mavjud emas</p>
                    </div>
                {% endif %}
            </div>

            <div class="chat-pastki-qism">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="send_message">
                    <div class="chat-input-guruhi">
                        <label class="mb-0" style="cursor: pointer;">
                            <i class="bi bi-plus-circle fs-5" style="color: var(--ios-blue);"></i>
                            <input type="file" name="message_file" class="d-none" onchange="this.form.submit()">
                        </label>
                        <input type="text" name="message" placeholder="Xabar..." autocomplete="off">
                        <button type="submit" class="btn btn-link p-0">
                            <i class="bi bi-arrow-up-circle-fill fs-3" style="color: var(--ios-blue);"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chat = document.getElementById('chatMaydoni');
    if (chat) chat.scrollTop = chat.scrollHeight;
});
</script>
{% endblock %}