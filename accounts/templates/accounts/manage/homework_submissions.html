{% extends 'accounts/admin/base_admin.html' %}
{% load static %}

{% block title %}Uy Vazifalari{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/homework_scoped.css' %}">
{% endblock %}

{% block admin_content %}
<div class="vazifa-sahifa-wrapper">
    <!-- Sarlavha -->
    <div class="vz-sarlavha-blok">
        <h1 class="vz-asosiy-sarlavha">Uy Vazifalari</h1>
        <p class="vz-tavsif-pastki">O'quvchilarning topshirgan vazifalarini tekshiring va baholang</p>
    </div>

    <!-- Statistika Karuseli -->
    <div class="vz-statistika-idish">
        <div class="vz-gorizantal-scroll">
            <a href="{% url 'homework_submissions' %}" class="vz-mezon-karta {% if not status_filter %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-lavanda">
                    <i class="bi bi-stack"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.pending|add:stats.reviewing|add:stats.revision|add:stats.accepted }}</div>
                    <div class="vz-yorliq">Barchasi</div>
                </div>
            </a>
            
            <a href="?status=pending" class="vz-mezon-karta {% if status_filter == 'pending' %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-kehribar">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.pending }}</div>
                    <div class="vz-yorliq">Kutilmoqda</div>
                </div>
            </a>
            
            <a href="?status=reviewing" class="vz-mezon-karta {% if status_filter == 'reviewing' %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-okean">
                    <i class="bi bi-eye"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.reviewing }}</div>
                    <div class="vz-yorliq">Ko'rilmoqda</div>
                </div>
            </a>
            
            <a href="?status=revision" class="vz-mezon-karta {% if status_filter == 'revision' %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-quyosh">
                    <i class="bi bi-arrow-repeat"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.revision }}</div>
                    <div class="vz-yorliq">Qayta ishlash</div>
                </div>
            </a>
            
            <a href="?status=accepted" class="vz-mezon-karta {% if status_filter == 'accepted' %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-ormon">
                    <i class="bi bi-check-lg"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.accepted }}</div>
                    <div class="vz-yorliq">Qabul qilindi</div>
                </div>
            </a>
            
            <a href="?status=graded" class="vz-mezon-karta {% if status_filter == 'graded' %}vz-faol{% endif %}">
                <div class="vz-belgi-idish vz-lavanda">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="vz-mezon-malumot">
                    <div class="vz-raqam">{{ stats.graded }}</div>
                    <div class="vz-yorliq">Baholangan</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Filtr -->
    <form method="GET" class="vz-filtr-panel">
        <i class="bi bi-funnel vz-filtr-icon"></i>
        
        {% if status_filter %}
            <input type="hidden" name="status" value="{{ status_filter }}">
        {% endif %}
        
        <select name="profession" class="vz-filtr-select" onchange="this.form.submit()">
            <option value="">ðŸ“š Barcha kurslar</option>
            {% for p in professions %}
                <option value="{{ p.pk }}" {% if profession_filter == p.pk|stringformat:"i" %}selected{% endif %}>
                    {{ p.name }}
                </option>
            {% endfor %}
        </select>
        
        {% if status_filter or profession_filter %}
            <a href="{% url 'homework_submissions' %}" class="vz-filtr-tozalash">
                <i class="bi bi-x-lg"></i>
                <span>Tozalash</span>
            </a>
        {% endif %}
    </form>

    <!-- Topshiriqlar Kolleksiyasi -->
    <div class="vz-kolleksiya">
        <div class="vz-kolleksiya-sarlavha">
            <span>
                {% if status_filter %}
                    {% if status_filter == 'pending' %}Kutilayotgan
                    {% elif status_filter == 'reviewing' %}Ko'rilayotgan
                    {% elif status_filter == 'revision' %}Qayta ishlanayotgan
                    {% elif status_filter == 'accepted' %}Qabul qilingan
                    {% elif status_filter == 'graded' %}Baholangan
                    {% endif %}
                    vazifalar
                {% else %}
                    Barcha ochiq vazifalar
                {% endif %}
            </span>
            <span class="vz-kolleksiya-son">{{ submissions|length }}</span>
        </div>
        
        {% if submissions %}
            {% for sub in submissions %}
                <a href="{% url 'grade_homework' sub.pk %}" class="vz-topshiriq">
                    <div class="vz-talaba-avatar vz-{% if sub.status == 'pending' %}kutilmoqda{% elif sub.status == 'reviewing' %}korilmoqda{% elif sub.status == 'revision' %}tuzatish{% elif sub.status == 'accepted' %}tasdiqlangan{% elif sub.status == 'graded' %}baholangan{% endif %}">
                        {% if sub.student.photo %}
                            <img src="{{ sub.student.photo.url }}" alt="{{ sub.student.full_name }}">
                        {% else %}
                            {{ sub.student.get_initials }}
                        {% endif %}
                        
                        {% if sub.messages.count > 0 %}
                            <span class="vz-xabar-belgi">{{ sub.messages.count }}</span>
                        {% endif %}
                    </div>
                    
                    <div class="vz-mazmun">
                        <h6 class="vz-talaba-ism">
                            {{ sub.student.full_name }}
                            
                            {% if sub.is_late %}
                                <span class="vz-tag vz-kechikkan">
                                    <i class="bi bi-clock"></i>
                                    Kech
                                </span>
                            {% endif %}
                            
                            {% if sub.revision_count > 0 %}
                                <span class="vz-tag vz-qayta">
                                    <i class="bi bi-arrow-repeat"></i>
                                    {{ sub.revision_count }}x
                                </span>
                            {% endif %}
                        </h6>
                        
                        <p class="vz-metadata">
                            <span>
                                <i class="bi bi-journal-text"></i>
                                {{ sub.homework.lesson.title|truncatewords:4 }}
                            </span>
                            <span class="vz-nuqta">â€¢</span>
                            <span>{{ sub.homework.lesson.profession.name }}</span>
                        </p>
                    </div>
                    
                    <div class="vz-holat-panel">
                        <span class="vz-holat-belgi vz-h-{% if sub.status == 'pending' %}kutilmoqda{% elif sub.status == 'reviewing' %}korilmoqda{% elif sub.status == 'revision' %}tuzatish{% elif sub.status == 'accepted' %}tasdiqlangan{% elif sub.status == 'graded' %}baholangan{% endif %}">
                            {% if sub.status == 'pending' %}
                                Kutilmoqda
                            {% elif sub.status == 'reviewing' %}
                                Ko'rilmoqda
                            {% elif sub.status == 'revision' %}
                                Qayta ishlash
                            {% elif sub.status == 'accepted' %}
                                Qabul qilindi
                            {% elif sub.status == 'graded' %}
                                {{ sub.grade }}%
                            {% endif %}
                        </span>
                        <span class="vz-vaqt">{{ sub.submitted_at|timesince }} oldin</span>
                    </div>
                    
                    <i class="bi bi-chevron-right vz-strelka"></i>
                </a>
            {% endfor %}
        {% else %}
            <div class="vz-bosh">
                <div class="vz-bosh-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <h5 class="vz-bosh-sarlavha">Vazifalar topilmadi</h5>
                <p class="vz-bosh-matn">
                    {% if status_filter or profession_filter %}
                        Bu filtrda hech qanday vazifa yo'q. Boshqa filtrlarni sinab ko'ring.
                    {% else %}
                        Hozircha hech qanday vazifa topshirilmagan.
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Gorizontal scroll aniqlash
document.addEventListener('DOMContentLoaded', function() {
    const statistikaIdish = document.querySelector('.vz-statistika-idish');
    const scroll = document.querySelector('.vz-gorizantal-scroll');
    
    if (scroll && statistikaIdish) {
        function toshishniTekshir() {
            const toshishBor = scroll.scrollWidth > scroll.clientWidth;
            if (toshishBor) {
                statistikaIdish.classList.add('vz-toshib-ketgan');
            } else {
                statistikaIdish.classList.remove('vz-toshib-ketgan');
            }
        }
        
        toshishniTekshir();
        window.addEventListener('resize', toshishniTekshir);
        
        // Sichqoncha g'ildiragida silliq scroll
        scroll.addEventListener('wheel', function(e) {
            if (e.deltaY !== 0) {
                e.preventDefault();
                scroll.scrollLeft += e.deltaY;
            }
        }, { passive: false });
    }
});
</script>
{% endblock %}