{% extends 'accounts/base.html' %}

{% block title %}{{ product.name }} | Coin Market - IT Creative{% endblock %}

{% block extra_css %}
<style>

/* ===== THEME VARS ===== */
.detail-wrap{--border:rgba(0,0,0,.08);--shadow:0 15px 40px rgba(0,0,0,.12)}
[data-bs-theme="dark"] .detail-wrap{--border:rgba(255,255,255,.1);--shadow:0 25px 60px rgba(0,0,0,.7)}

/* ===== HERO CARD ===== */
.product-hero{
    border-radius:1.5rem;overflow:hidden;border:1px solid var(--border);
    background:var(--bs-body-bg);box-shadow:var(--shadow)
}
.product-img{max-height:420px;object-fit:cover}

/* ===== PRICE BAR ===== */
.price-bar{
    background:linear-gradient(135deg,#6366f1,#8b5cf6);
    color:#fff;border-radius:1rem;padding:1rem 1.2rem
}
.coin-badge{background:rgba(255,255,255,.2);padding:.5rem 1rem;border-radius:2rem;font-weight:700}

/* ===== ACTIONS ===== */
.action-btn{border-radius:2rem;font-weight:600}
.like-btn{transition:.2s}
.like-btn:hover{transform:scale(1.1)}

/* ===== COMMENT ===== */
.comment-box{border-radius:1rem;border:1px solid var(--border);background:var(--bs-tertiary-bg)}
.avatar{width:42px;height:42px;object-fit:cover;border-radius:50%}

</style>
{% endblock %}

{% block content %}
<div class="container py-5 detail-wrap">

<div class="row justify-content-center">
<div class="col-lg-9">



<!-- ================= PRODUCT HERO ================= -->
<div class="product-hero mb-5">

{% if product.image %}
<img src="{{ product.image.url }}" class="w-100 product-img">
{% endif %}

<div class="p-4 p-lg-5">

    <!-- PRICE BAR -->
    <div class="price-bar mb-4 d-flex flex-wrap justify-content-between align-items-center gap-3">

        <div class="coin-badge fs-5">
            <i class="bi bi-coin me-1"></i>{{ product.coin_price }} coin
        </div>

        {% if product.stock > 0 %}
            <span class="badge bg-success fs-6 px-3 py-2 rounded-pill">{{ product.stock }} ta mavjud</span>
        {% else %}
            <span class="badge bg-danger fs-6 px-3 py-2 rounded-pill">Tugagan</span>
        {% endif %}
    </div>

    <h1 class="fw-bold mb-4">{{ product.name }}</h1>

    <div class="mb-5 text-body-secondary" style="white-space:pre-wrap">
        {{ product.description }}
    </div>

    <!-- ===== ACTIONS ===== -->
    <div class="d-flex flex-wrap gap-3 align-items-center border-top pt-4">

        <!-- LIKE -->
        <a href="{% url 'market_like' product.pk %}"
           class="btn action-btn {% if is_liked %}btn-danger{% else %}btn-outline-danger{% endif %}">
            <i class="bi {% if is_liked %}bi-heart-fill{% else %}bi-heart{% endif %} me-2"></i>
            Like ({{ product.likes.count }})
        </a>

        <span class="text-muted">
            <i class="bi bi-chat-dots me-1"></i>{{ product.comments.count }} izoh
        </span>

        <!-- BUY -->
        {% if product.stock > 0 %}
            {% if user.coins >= product.coin_price %}
            <a href="{% url 'market_purchase' product.pk %}"
               class="btn btn-success action-btn ms-auto">
                <i class="bi bi-cart-check me-2"></i>Sotib olish
            </a>
            {% else %}
            <button class="btn btn-secondary action-btn ms-auto" disabled>
                <i class="bi bi-wallet2 me-2"></i>Coin yetarli emas
            </button>
            {% endif %}
        {% endif %}
    </div>

    <div class="mt-3 small text-muted">
        <i class="bi bi-wallet2 me-1"></i>Balansingiz: <b>{{ user.coins }}</b> coin
    </div>

</div>
</div>

<!-- ================= COMMENTS ================= -->
<div class="product-hero p-4 p-lg-5">

<h4 class="mb-4">Izohlar ({{ comments.count }})</h4>

<!-- FORM -->
<form method="post" class="mb-5">
    {% csrf_token %}
    <textarea name="content" rows="3" class="form-control mb-3"
        placeholder="Fikringizni yozing... (+1 coin)" required></textarea>
    <div class="text-end">
        <button class="btn btn-primary action-btn">
            <i class="bi bi-send me-1"></i>Yuborish
        </button>
    </div>
</form>

<!-- LIST -->
<div class="d-flex flex-column gap-4">

{% for comment in comments %}
<div class="d-flex gap-3">

    {% if comment.user.photo %}
        <img src="{{ comment.user.photo.url }}" class="avatar">
    {% else %}
        <div class="avatar bg-secondary-subtle d-flex align-items-center justify-content-center">
            <i class="bi bi-person-fill"></i>
        </div>
    {% endif %}

    <div class="flex-grow-1 comment-box p-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
            <b>{{ comment.user.full_name }}</b>
            <small class="text-muted">{{ comment.created_at|timesince }} oldin</small>
        </div>
        <p class="mb-0">{{ comment.content }}</p>
    </div>

</div>
{% empty %}
<p class="text-center text-muted my-4">
    Hozircha izohlar yoâ€˜q. Birinchi boâ€˜lib yozing ðŸ˜‰
</p>
{% endfor %}

</div>

</div>

</div>
</div>
</div>
{% endblock %}
