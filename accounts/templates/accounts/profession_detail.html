{% extends 'accounts/base.html' %}

{% block title %}{{ profession.name }} - LMS | IT Creative{% endblock %}

{% block extra_css %}
<style>
/* ===== iOS STYLE COLORS ===== */
:root{
    --card-bg: rgba(255,255,255,.75);
    --card-border: rgba(0,0,0,.08);
    --text-main: #111;
    --soft-bg: rgba(0,0,0,.04);
}
[data-bs-theme="dark"]{
    --card-bg: rgba(20,20,20,.75);
    --card-border: rgba(255,255,255,.08);
    --text-main: #f1f1f1;
    --soft-bg: rgba(255,255,255,.06);
}

/* ===== CARDS ===== */
.ios-card{
    background: var(--card-bg);
    backdrop-filter: blur(14px);
    border: 1px solid var(--card-border);
    border-radius: 22px;
    box-shadow: 0 12px 35px rgba(0,0,0,.15);
}

/* ===== IMAGE ===== */
.prof-img{
    height:240px;
    object-fit:cover;
    border-top-left-radius:22px;
    border-top-right-radius:22px;
}

/* ===== BADGE ===== */
.ios-badge{
    background: var(--soft-bg);
    color: var(--text-main);
    border-radius: 999px;
    padding: .4rem .9rem;
    font-size: .85rem;
}

/* ===== LIST ===== */
.ios-list .list-group-item{
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--card-border);
    padding: .9rem .3rem;
    color: var(--text-main);
}
.ios-list .list-group-item:hover{
    background: var(--soft-bg);
}

/* ===== BUTTONS ===== */
.ios-btn{
    border-radius: 14px;
    font-weight: 600;
}

/* ===== ACCORDION ===== */
.section-accordion .accordion-item{
    background: transparent;
    border: 1px solid var(--card-border);
    border-radius: 14px !important;
    margin-bottom: 12px;
    overflow: hidden;
}
.section-accordion .accordion-button{
    background: var(--soft-bg);
    color: var(--text-main);
    font-weight: 600;
    border-radius: 14px !important;
}
.section-accordion .accordion-button:not(.collapsed){
    background: linear-gradient(135deg, #0d6efd22, #6610f222);
    color: var(--text-main);
    box-shadow: none;
}
.section-accordion .accordion-button::after{
    filter: var(--bs-accordion-btn-icon-filter);
}
.section-accordion .accordion-body{
    padding: 0;
}
.section-badge{
    font-size: .75rem;
    padding: .25rem .6rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container my-4 my-md-5">

<a href="{% url 'professions' %}" class="btn btn-outline-secondary mb-4 ios-btn">
    <i class="bi bi-arrow-left me-2"></i>Orqaga
</a>

<div class="row g-4">

<!-- ===== LEFT CARD ===== -->
<div class="col-md-4">
<div class="ios-card h-100">

    <img src="{{ profession.photo.url }}" class="w-100 prof-img" alt="{{ profession.name }}">

    <div class="p-4 text-center">

        <h4 class="fw-bold mb-2">{{ profession.name }}</h4>

        <p class="text-muted small mb-3">{{ profession.description }}</p>

        <div class="mb-3">
            <span class="ios-badge">
                <i class="bi bi-people me-1"></i>{{ profession.student_count }} o'quvchi
            </span>
        </div>

        {% if user.is_student %}
            {% if is_enrolled %}
                <div class="alert alert-success py-2 small">
                    <i class="bi bi-check-circle me-1"></i> Siz kursga yozilgansiz
                </div>
            {% else %}
                <a href="{% url 'enroll_course' profession.pk %}"
                   class="btn btn-primary w-100 ios-btn">
                    <i class="bi bi-play-circle me-2"></i>O'qishni boshlash
                </a>
            {% endif %}
        {% endif %}

        {% if user.is_admin or user.is_teacher %}
        <a href="{% url 'manage_lessons' profession.pk %}"
           class="btn btn-outline-primary w-100 mt-2 ios-btn">
            <i class="bi bi-journal-text me-2"></i>Mavzularni boshqarish
        </a>
        {% endif %}

    </div>
</div>
</div>

<!-- ===== RIGHT CARD ===== -->
<div class="col-md-8">

{% if is_enrolled or user.is_admin or user.is_teacher %}

<div class="ios-card">

    <div class="p-4 border-bottom" style="border-color:var(--card-border)!important;">
        <h5 class="m-0 fw-semibold">
            <i class="bi bi-list-ul me-2"></i>Darslar
        </h5>
    </div>

    <div class="p-3">

        {% if sections or lessons_without_section %}
        
        <!-- Sections with accordion -->
        {% if sections %}
        <div class="accordion section-accordion" id="sectionsAccordion">
            {% for section in sections %}
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#section{{ section.pk }}">
                        <i class="bi bi-folder2-open me-2 text-primary"></i>
                        {{ section.title }}
                        <span class="badge bg-primary section-badge ms-2">{{ section.lessons.count }} dars</span>
                    </button>
                </h2>
                <div id="section{{ section.pk }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                     data-bs-parent="#sectionsAccordion">
                    <div class="accordion-body">
                        {% if section.description %}
                        <div class="p-3 text-muted small border-bottom" style="border-color:var(--card-border)!important;">
                            {{ section.description }}
                        </div>
                        {% endif %}
                        
                        {% if section.lessons.all %}
                        <div class="list-group list-group-flush ios-list">
                            {% for lesson in section.lessons.all %}
                            <a href="{% url 'lesson_view' lesson.pk %}"
                               class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    {% if lesson.lesson_type == 'video' %}
                                        <i class="bi bi-play-circle text-primary"></i>
                                    {% elif lesson.lesson_type == 'homework' %}
                                        <i class="bi bi-file-earmark-text text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-question-circle text-success"></i>
                                    {% endif %}
                                    <span>{{ lesson.title }}</span>
                                </div>
                                <span class="badge bg-secondary bg-opacity-50">
                                    {{ lesson.get_lesson_type_display }}
                                </span>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-inbox"></i>
                            <p class="mb-0 small">Bu bo'limda hali darslar yo'q</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Lessons without section -->
        {% if lessons_without_section %}
        <div class="mt-3">
            <h6 class="text-muted mb-3">
                <i class="bi bi-collection me-2"></i>Boshqa darslar
            </h6>
            <div class="list-group list-group-flush ios-list">
                {% for lesson in lessons_without_section %}
                <a href="{% url 'lesson_view' lesson.pk %}"
                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2">
                        {% if lesson.lesson_type == 'video' %}
                            <i class="bi bi-play-circle text-primary"></i>
                        {% elif lesson.lesson_type == 'homework' %}
                            <i class="bi bi-file-earmark-text text-warning"></i>
                        {% else %}
                            <i class="bi bi-question-circle text-success"></i>
                        {% endif %}
                        <span>{{ lesson.title }}</span>
                    </div>
                    <span class="badge bg-secondary bg-opacity-50">
                        {{ lesson.get_lesson_type_display }}
                    </span>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2 mb-0">Hozircha darslar mavjud emas</p>
        </div>
        {% endif %}

    </div>
</div>

{% else %}

<div class="ios-card text-center p-5">
    <i class="bi bi-lock fs-1 text-muted"></i>
    <h5 class="mt-3">Darslarni ko'rish uchun kursga yoziling</h5>
    <a href="{% url 'enroll_course' profession.pk %}" class="btn btn-primary mt-3 ios-btn">
        <i class="bi bi-play-circle me-2"></i>O'qishni boshlash
    </a>
</div>

{% endif %}

</div>

</div>
</div>
{% endblock %}
