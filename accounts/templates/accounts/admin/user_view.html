{% extends 'accounts/admin/base_admin.html' %}

{% block title %}{{ user_obj.full_name }} | Admin Panel{% endblock %}

{% block admin_content %}

<a href="{% url 'admin_users' %}" class="btn btn-outline-secondary rounded-pill mb-4">
    <i class="bi bi-arrow-left me-1"></i>Orqaga
</a>

<div class="row g-4">

<!-- ================= LEFT PROFILE ================= -->
<div class="col-lg-4">

<div class="card text-center p-4 h-100">

    <!-- AVATAR -->
    <div class="mb-3">

        {% if user_obj.photo and user_obj.photo.url %}
            <img src="{{ user_obj.photo.url }}"
                 class="rounded-circle"
                 style="width:140px;height:140px;object-fit:cover;border:4px solid #6366f1;">
        {% else %}
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center fw-bold mx-auto"
                 style="width:140px;height:140px;font-size:3rem;">
                {{ user_obj.get_initials }}
            </div>
        {% endif %}

    </div>

    <h4 class="fw-bold mb-0">{{ user_obj.full_name }}</h4>
    <small class="text-muted">@{{ user_obj.username }}</small>

    <!-- ROLE -->
    <div class="my-3">
        <span class="badge rounded-pill px-4 py-2
            {% if user_obj.role == 'admin' %}bg-danger
            {% elif user_obj.role == 'teacher' %}bg-success
            {% else %}bg-primary{% endif %}">
            {% if user_obj.role == 'admin' %}Admin
            {% elif user_obj.role == 'teacher' %}O‘qituvchi
            {% else %}O‘quvchi{% endif %}
        </span>
    </div>

    <!-- COINS -->
    <div class="mb-3">
        <span class="badge rounded-pill fs-6 px-4 py-2 text-dark"
              style="background:linear-gradient(135deg,#facc15,#f59e0b);">
            <i class="bi bi-coin me-1"></i>{{ user_obj.coins }} coin
        </span>
    </div>

    <hr>

    <!-- ACTIONS -->
    <div class="d-grid gap-2">

        <a href="{% url 'admin_user_edit' user_obj.pk %}" class="btn btn-primary rounded-pill">
            <i class="bi bi-pencil me-1"></i>Tahrirlash
        </a>

        <a href="{% url 'user_statistics' user_obj.pk %}" class="btn btn-outline-info rounded-pill">
            <i class="bi bi-graph-up me-1"></i>Statistika
        </a>

        {% if user_obj.is_student %}
        <a href="{% url 'issue_certificate' user_obj.pk %}" class="btn btn-outline-success rounded-pill">
            <i class="bi bi-award me-1"></i>Sertifikat berish
        </a>
        {% endif %}

        {% if not user_obj.is_admin %}
        <a href="{% url 'admin_user_block' user_obj.pk %}"
           class="btn {% if user_obj.is_blocked %}btn-success{% else %}btn-warning{% endif %} rounded-pill">
            <i class="bi bi-{% if user_obj.is_blocked %}unlock{% else %}lock{% endif %} me-1"></i>
            {% if user_obj.is_blocked %}Blokdan chiqarish{% else %}Bloklash{% endif %}
        </a>
        {% endif %}

        <a href="{% url 'admin_user_devices' user_obj.pk %}" class="btn btn-outline-secondary rounded-pill">
            <i class="bi bi-laptop me-1"></i>Qurilmalar ({{ user_obj.devices.count }})
        </a>

    </div>

</div>
</div>

<!-- ================= RIGHT INFO ================= -->
<div class="col-lg-8 d-flex flex-column gap-4">

<!-- INFO CARD -->
<div class="card p-4">

<h5 class="fw-bold mb-3">
    <i class="bi bi-person-lines-fill me-2"></i>Ma’lumotlar
</h5>

<div class="row g-3">

<div class="col-md-6">
    <small class="text-muted">Telefon</small>
    <div>{{ user_obj.phone|default:"-" }}</div>
</div>

<div class="col-md-6">
    <small class="text-muted">Ro‘yxatdan o‘tgan</small>
    <div>{{ user_obj.date_joined|date:"d.m.Y H:i" }}</div>
</div>

<div class="col-md-6">
    <small class="text-muted">Manzil</small>
    <div>{{ user_obj.address|default:"-" }}</div>
</div>

<div class="col-md-6">
    <small class="text-muted">Tug‘ilgan sana</small>
    <div>
        {% if user_obj.birth_date %}{{ user_obj.birth_date|date:"d.m.Y" }}{% else %}-{% endif %}
    </div>
</div>

{% if user_obj.id_card or user_obj.birth_certificate %}
<div class="col-12">
    <small class="text-muted">Hujjatlar</small><br>

    {% if user_obj.id_card and user_obj.id_card.url %}
        <a href="{{ user_obj.id_card.url }}" target="_blank"
           class="btn btn-sm btn-outline-info rounded-pill me-2">
            <i class="bi bi-person-badge me-1"></i>ID karta
        </a>
    {% endif %}

    {% if user_obj.birth_certificate and user_obj.birth_certificate.url %}
        <a href="{{ user_obj.birth_certificate.url }}" target="_blank"
           class="btn btn-sm btn-outline-info rounded-pill">
            <i class="bi bi-file-earmark-text me-1"></i>Guvohnoma
        </a>
    {% endif %}
</div>
{% endif %}

<div class="col-md-6">
    <small class="text-muted">Oxirgi faollik</small>
    <div>
        {% if user_obj.last_activity %}
            {{ user_obj.last_activity|date:"d.m.Y H:i" }}
        {% else %}-{% endif %}
    </div>
</div>

<div class="col-md-6">
    <small class="text-muted">Status</small><br>

    {% if user_obj.is_blocked %}
        <span class="badge bg-danger rounded-pill px-3">Bloklangan</span>
    {% elif user_obj.is_online %}
        <span class="badge bg-success rounded-pill px-3">Online</span>
    {% else %}
        <span class="badge bg-secondary rounded-pill px-3">Offline</span>
    {% endif %}
</div>

</div>
</div>

<!-- CERTIFICATES -->
{% if certificates %}
<div class="card p-4">

<h5 class="fw-bold mb-3">
    <i class="bi bi-award me-2"></i>Sertifikatlar
</h5>

<div class="table-responsive">
<table class="table table-hover align-middle">

<thead>
<tr>
    <th>Yo‘nalish</th>
    <th>Sana</th>
    <th>Bergan</th>
    <th>Fayl</th>
</tr>
</thead>

<tbody>
{% for cert in certificates %}
<tr>
    <td>{{ cert.profession.name }}</td>
    <td>{{ cert.issued_at|date:"d.m.Y" }}</td>
    <td>{{ cert.issued_by.full_name }}</td>
    <td>
        {% if cert.file and cert.file.url %}
        <a href="{{ cert.file.url }}" target="_blank"
           class="btn btn-sm btn-outline-primary rounded-pill">
            <i class="bi bi-download"></i>
        </a>
        {% endif %}
    </td>
</tr>
{% endfor %}
</tbody>

</table>
</div>

</div>
{% endif %}

</div>
</div>

<!-- ================= STUDENT ANALYSIS ================= -->
{% if user_obj.role == 'student' and analysis_data %}
<div class="row mt-4">
<div class="col-12">
    <h4 class="fw-bold mb-4">
        <i class="bi bi-graph-up-arrow me-2 text-primary"></i>O'quvchi Tahlili
    </h4>
</div>
</div>

<!-- Coin Stats Card -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card text-center p-4" style="background: linear-gradient(135deg, #facc15, #f59e0b); color: #000;">
            <h3 class="mb-0 fw-bold">{{ user_obj.coins }}</h3>
            <small>Joriy coinlar</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center p-4 bg-success text-white">
            <h3 class="mb-0 fw-bold">+{{ coin_earned }}</h3>
            <small>Jami ishlangan</small>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center p-4 bg-danger text-white">
            <h3 class="mb-0 fw-bold">-{{ coin_spent }}</h3>
            <small>Jami sarflangan</small>
        </div>
    </div>
</div>

<!-- Course Analysis Cards -->
{% for data in analysis_data %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="bi bi-book me-2"></i>
            <strong>{{ data.profession.name }}</strong>
            <small class="text-muted ms-2">Yozilgan: {{ data.enrollment.enrolled_at|date:"d.m.Y" }}</small>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="progress" style="width: 150px; height: 10px;">
                <div class="progress-bar bg-success" style="width: {{ data.overall_progress }}%"></div>
            </div>
            <span class="badge bg-primary">{{ data.overall_progress }}%</span>
        </div>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <!-- Video Progress -->
            <div class="col-md-3">
                <div class="text-center p-3 rounded" style="background: var(--bs-tertiary-bg);">
                    <i class="bi bi-play-circle fs-2 text-info mb-2 d-block"></i>
                    <h4 class="mb-0">{{ data.watched_videos }}/{{ data.total_videos }}</h4>
                    <small class="text-muted">Video ko'rilgan</small>
                </div>
            </div>
            
            <!-- Test Stats -->
            <div class="col-md-3">
                <div class="text-center p-3 rounded" style="background: var(--bs-tertiary-bg);">
                    <i class="bi bi-check2-square fs-2 text-success mb-2 d-block"></i>
                    <h4 class="mb-0">{{ data.tests_taken }} <small class="text-muted fs-6">({{ data.avg_test_score }}%)</small></h4>
                    <small class="text-muted">Test topshirgan</small>
                    <div class="mt-1">
                        <span class="badge bg-success">{{ data.passed_tests }} o'tdi</span>
                    </div>
                </div>
            </div>
            
            <!-- Homework Stats -->
            <div class="col-md-3">
                <div class="text-center p-3 rounded" style="background: var(--bs-tertiary-bg);">
                    <i class="bi bi-file-earmark-check fs-2 text-warning mb-2 d-block"></i>
                    <h4 class="mb-0">{{ data.submitted_homeworks }}/{{ data.total_homeworks }}</h4>
                    <small class="text-muted">Vazifa topshirgan</small>
                    <div class="mt-1">
                        {% if data.pending_homeworks > 0 %}
                        <span class="badge bg-warning text-dark">{{ data.pending_homeworks }} kutilmoqda</span>
                        {% endif %}
                        {% if data.graded_homeworks > 0 %}
                        <span class="badge bg-success">{{ data.graded_homeworks }} baholangan</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Average Grade -->
            <div class="col-md-3">
                <div class="text-center p-3 rounded" style="background: var(--bs-tertiary-bg);">
                    <i class="bi bi-star fs-2 text-primary mb-2 d-block"></i>
                    <h4 class="mb-0">{{ data.avg_homework_grade }}</h4>
                    <small class="text-muted">O'rtacha baho</small>
                </div>
            </div>
        </div>
        
        <!-- Stuck Lessons -->
        {% if data.stuck_lessons %}
        <div class="mt-4">
            <h6 class="fw-bold text-danger mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>Tugatilmagan darslar
            </h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Dars</th>
                            <th class="text-center">Video</th>
                            <th class="text-center">Test</th>
                            <th class="text-center">Vazifa</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stuck in data.stuck_lessons %}
                        <tr>
                            <td>{{ stuck.lesson.title }}</td>
                            <td class="text-center">
                                <span class="badge {% if '0/' in stuck.video_progress %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                    {{ stuck.video_progress }}
                                </span>
                            </td>
                            <td class="text-center">
                                {% if stuck.test_done == None %}
                                <span class="badge bg-secondary">-</span>
                                {% elif stuck.test_done %}
                                <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if stuck.hw_done == None %}
                                <span class="badge bg-secondary">-</span>
                                {% elif stuck.hw_done %}
                                <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                {% else %}
                                <span class="badge bg-danger"><i class="bi bi-x"></i></span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}

<!-- Recent Activities -->
{% if recent_activities %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-activity me-2"></i>Oxirgi harakatlar
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Amal</th>
                        <th>Tavsif</th>
                        <th>Vaqt</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in recent_activities %}
                    <tr>
                        <td>
                            {% if activity.action_type == 'login' %}
                            <span class="badge bg-info"><i class="bi bi-box-arrow-in-right"></i></span>
                            {% elif activity.action_type == 'deploy_create' %}
                            <span class="badge bg-success"><i class="bi bi-rocket"></i></span>
                            {% elif activity.action_type == 'submit_test' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-check2-square"></i></span>
                            {% elif activity.action_type == 'watch_video' %}
                            <span class="badge bg-primary"><i class="bi bi-play-circle"></i></span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-activity"></i></span>
                            {% endif %}
                        </td>
                        <td class="small">{{ activity.description|truncatewords:10 }}</td>
                        <td class="small text-muted">{{ activity.created_at|timesince }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

{% endblock %}
