{% extends 'accounts/admin/base_admin.html' %}
{% load static %}

{% block title %}Darslar Tahlili - Admin Panel{% endblock %}

{% block admin_content %}
<!-- Top Bar -->
<div class="top-bar">
    <h1 class="page-title"><i class="bi bi-bar-chart-line me-2"></i>Darslar Tahlili</h1>
    <div class="d-flex gap-2">
        <a href="{% url 'admin_reports' %}" class="btn btn-primary">
            <i class="bi bi-file-pdf me-2"></i>PDF Hisobot
        </a>
    </div>
</div>

<!-- Ogohlantirishlar -->
{% if alerts %}
<div class="row g-2 mb-4">
    {% for a in alerts %}
    <div class="col-md-3">
        <div class="alert alert-{{ a.type }} d-flex align-items-center gap-2 mb-0 py-2">
            <i class="bi {{ a.icon }}"></i>
            <small>{{ a.title }}</small>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Filter -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label small">Qidirish</label>
                <input type="text" name="q" class="form-control" placeholder="Dars nomi..." value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small">Kurs</label>
                <select name="profession" class="form-select">
                    <option value="">Barcha kurslar</option>
                    {% for p in professions %}
                    <option value="{{ p.pk }}" {% if selected_profession == p.pk|stringformat:"i" %}selected{% endif %}>{{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small">Dan</label>
                <input type="date" name="date_from" class="form-control" value="{% if date_from %}{{ date_from|date:'Y-m-d' }}{% endif %}">
            </div>
            <div class="col-md-2">
                <label class="form-label small">Gacha</label>
                <input type="date" name="date_to" class="form-control" value="{% if date_to %}{{ date_to|date:'Y-m-d' }}{% endif %}">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Qidirish</button>
            </div>
        </form>
    </div>
</div>

<!-- Statistika kartochkalari -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon purple mx-auto mb-2"><i class="bi bi-journal-bookmark"></i></div>
            <div class="stat-number">{{ total_lessons }}</div>
            <div class="stat-label">Jami darslar</div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon blue mx-auto mb-2"><i class="bi bi-people"></i></div>
            <div class="stat-number">{{ active_students }}/{{ total_students }}</div>
            <div class="stat-label">Faol o'quvchilar</div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon green mx-auto mb-2"><i class="bi bi-play-circle"></i></div>
            <div class="stat-number">{{ total_video_views }}</div>
            <div class="stat-label">Ko'rilgan videolar</div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon orange mx-auto mb-2"><i class="bi bi-clipboard-check"></i></div>
            <div class="stat-number">{{ total_test_attempts }}</div>
            <div class="stat-label">Test urinishlari</div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon cyan mx-auto mb-2"><i class="bi bi-percent"></i></div>
            <div class="stat-number">{{ avg_test_score }}%</div>
            <div class="stat-label">O'rtacha ball</div>
        </div>
    </div>
    <div class="col-6 col-md-4 col-lg-2">
        <div class="stat-card text-center">
            <div class="stat-icon red mx-auto mb-2"><i class="bi bi-check2-circle"></i></div>
            <div class="stat-number">{{ completion_percent }}%</div>
            <div class="stat-label">Tugallangan</div>
        </div>
    </div>
</div>

<!-- Grafik -->
<div class="card mb-4">
    <div class="card-header"><i class="bi bi-graph-up me-2"></i>Kunlik faollik (oxirgi 30 kun)</div>
    <div class="card-body">
        <canvas id="activityChart" height="100"></canvas>
    </div>
</div>

<!-- Tab Navigation -->
<ul class="nav nav-tabs mb-3" id="statTabs" role="tablist">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabOverview"><i class="bi bi-grid me-1"></i>Umumiy</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabVideos"><i class="bi bi-camera-video me-1"></i>Videolar</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabTests"><i class="bi bi-clipboard me-1"></i>Testlar</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabHomework"><i class="bi bi-journal-text me-1"></i>Vazifalar</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabStudents"><i class="bi bi-people me-1"></i>O'quvchilar</a></li>
</ul>

<div class="tab-content">
    <!-- Umumiy -->
    <div class="tab-pane fade show active" id="tabOverview">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="bi bi-award me-2 text-success"></i>Sertifikatga yaqin o'quvchilar</span>
                        <span class="badge bg-success">{{ near_certificate_students|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        {% if near_certificate_students %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <tbody>
                                    {% for s in near_certificate_students %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                {% if s.student.photo %}
                                                <img src="{{ s.student.photo.url }}" class="user-avatar-sm">
                                                {% else %}
                                                <div class="user-avatar-placeholder">{{ s.student.get_initials }}</div>
                                                {% endif %}
                                                <div>
                                                    <div class="fw-bold">{{ s.student.full_name }}</div>
                                                    <small class="text-muted">{{ s.profession.name }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <span class="badge bg-success">{{ s.progress }}%</span>
                                            <small class="text-muted d-block">{{ s.remaining }} dars qoldi</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-award fs-1 opacity-25"></i>
                            <p class="mt-2">Hozircha yo'q</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header"><i class="bi bi-trophy me-2 text-warning"></i>TOP-5 Videolar</div>
                    <div class="card-body p-0">
                        {% if top_video_lessons %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <tbody>
                                    {% for v in top_video_lessons|slice:":5" %}
                                    <tr>
                                        <td width="40"><span class="badge bg-primary">{{ forloop.counter }}</span></td>
                                        <td>
                                            <div class="fw-bold">{{ v.lesson.title }}</div>
                                            <small class="text-muted">{{ v.lesson.profession.name }}</small>
                                        </td>
                                        <td class="text-end"><span class="badge bg-info">{{ v.watched }} ko'rilgan</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted"><i class="bi bi-camera-video fs-1 opacity-25"></i><p class="mt-2">Ma'lumot yo'q</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Videolar -->
    <div class="tab-pane fade" id="tabVideos">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-camera-video me-2"></i>Video darslar statistikasi</span>
                <span class="badge bg-primary">{{ video_stats|length }}</span>
            </div>
            <div class="card-body p-0">
                {% if video_stats %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr><th>Dars</th><th>Kurs</th><th>Ko'rilgan</th><th>Ko'rilmagan</th><th>Foiz</th></tr>
                        </thead>
                        <tbody>
                            {% for v in video_stats %}
                            <tr>
                                <td class="fw-bold">{{ v.lesson.title }}</td>
                                <td><small class="text-muted">{{ v.lesson.profession.name }}</small></td>
                                <td><span class="text-success"><i class="bi bi-check-circle me-1"></i>{{ v.watched }}</span></td>
                                <td><span class="text-danger"><i class="bi bi-x-circle me-1"></i>{{ v.not_watched }}</span></td>
                                <td>
                                    <div class="progress" style="height:8px;width:80px;">
                                        <div class="progress-bar {% if v.completion_rate >= 70 %}bg-success{% elif v.completion_rate >= 40 %}bg-warning{% else %}bg-danger{% endif %}" style="width:{{ v.completion_rate }}%"></div>
                                    </div>
                                    <small>{{ v.completion_rate }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted"><i class="bi bi-camera-video fs-1 opacity-25"></i><p class="mt-2">Video darslar yo'q</p></div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Testlar -->
    <div class="tab-pane fade" id="tabTests">
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="bi bi-clipboard-check me-2"></i>Testlar statistikasi</span>
                        <span class="badge bg-success">{{ test_stats|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        {% if test_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead><tr><th>Test</th><th>Urinish</th><th>O'tdi</th><th>Yiqildi</th><th>O'rtacha</th></tr></thead>
                                <tbody>
                                    {% for t in test_stats %}
                                    <tr>
                                        <td><div class="fw-bold">{{ t.lesson.title }}</div><small class="text-muted">{{ t.lesson.profession.name }}</small></td>
                                        <td>{{ t.total_attempts }}</td>
                                        <td><span class="text-success">{{ t.passed_count }}</span></td>
                                        <td><span class="text-danger">{{ t.failed_count }}</span></td>
                                        <td><span class="badge {% if t.avg_score >= 70 %}bg-success{% elif t.avg_score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">{{ t.avg_score }}%</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted"><i class="bi bi-clipboard fs-1 opacity-25"></i><p class="mt-2">Testlar yo'q</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="bi bi-exclamation-diamond me-2 text-danger"></i>Qiyin savollar</span>
                        <span class="badge bg-danger">{{ hardest_questions|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        {% if hardest_questions %}
                        <ul class="list-group list-group-flush">
                            {% for q in hardest_questions %}
                            <li class="list-group-item">
                                <div class="small">{{ q.question.question_text|truncatewords:15 }}</div>
                                <div class="d-flex gap-2 mt-1">
                                    <small class="text-muted">{{ q.test.lesson.title }}</small>
                                    <span class="badge bg-danger">{{ q.error_rate }}% xato</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <div class="text-center py-5 text-muted"><i class="bi bi-question-circle fs-1 opacity-25"></i><p class="mt-2">Qiyin savol yo'q</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Vazifalar -->
    <div class="tab-pane fade" id="tabHomework">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-journal-text me-2"></i>Uy vazifalari statistikasi</span>
                <span class="badge bg-warning text-dark">{{ homework_stats|length }}</span>
            </div>
            <div class="card-body p-0">
                {% if homework_stats %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead><tr><th>Vazifa</th><th>Kurs</th><th>Topshirgan</th><th>Topshirmagan</th><th>Kutilmoqda</th><th>O'rtacha baho</th></tr></thead>
                        <tbody>
                            {% for h in homework_stats %}
                            <tr>
                                <td class="fw-bold">{{ h.lesson.title }}</td>
                                <td><small class="text-muted">{{ h.lesson.profession.name }}</small></td>
                                <td><span class="text-success">{{ h.submitted }}</span></td>
                                <td><span class="text-danger">{{ h.not_submitted }}</span></td>
                                <td><span class="text-warning">{{ h.pending_count }}</span></td>
                                <td><span class="badge bg-info">{{ h.avg_grade }}%</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 text-muted"><i class="bi bi-journal fs-1 opacity-25"></i><p class="mt-2">Vazifalar yo'q</p></div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- O'quvchilar -->
    <div class="tab-pane fade" id="tabStudents">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="bi bi-moon-stars me-2 text-warning"></i>Passiv o'quvchilar (7+ kun)</span>
                        <span class="badge bg-warning text-dark">{{ passive_students|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        {% if passive_students %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <tbody>
                                    {% for s in passive_students %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                {% if s.photo %}<img src="{{ s.photo.url }}" class="user-avatar-sm">{% else %}<div class="user-avatar-placeholder">{{ s.get_initials }}</div>{% endif %}
                                                <div>
                                                    <div class="fw-bold">{{ s.full_name }}</div>
                                                    <small class="text-muted">{% if s.last_activity %}{{ s.last_activity|timesince }} oldin{% else %}Hech qachon{% endif %}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end"><a href="{% url 'admin_user_view' s.pk %}" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted"><i class="bi bi-emoji-smile fs-1 opacity-25"></i><p class="mt-2">Hammasi faol!</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span><i class="bi bi-exclamation-triangle me-2 text-danger"></i>Qiynalayotgan o'quvchilar</span>
                        <span class="badge bg-danger">{{ struggling_students|length }}</span>
                    </div>
                    <div class="card-body p-0">
                        {% if struggling_students %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <tbody>
                                    {% for s in struggling_students %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                {% if s.photo %}<img src="{{ s.photo.url }}" class="user-avatar-sm">{% else %}<div class="user-avatar-placeholder">{{ s.get_initials }}</div>{% endif %}
                                                <div>
                                                    <div class="fw-bold">{{ s.full_name }}</div>
                                                    <small class="text-muted">{{ s.low_score_count }} past ball â€¢ O'rtacha: {{ s.avg_score|floatformat:0 }}%</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-end"><a href="{% url 'admin_user_view' s.pk %}" class="btn btn-sm btn-outline-danger"><i class="bi bi-eye"></i></a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5 text-muted"><i class="bi bi-emoji-smile fs-1 opacity-25"></i><p class="mt-2">Hammasi yaxshi!</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const chartData = {{ daily_activity|safe }};
new Chart(document.getElementById('activityChart'), {
    type: 'line',
    data: {
        labels: chartData.map(d => d.date),
        datasets: [
            { label: 'Video', data: chartData.map(d => d.videos), borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: true, tension: 0.4 },
            { label: 'Test', data: chartData.map(d => d.tests), borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.4 },
            { label: 'Vazifa', data: chartData.map(d => d.homeworks), borderColor: '#fd7e14', backgroundColor: 'rgba(253,126,20,0.1)', fill: true, tension: 0.4 }
        ]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } },
        elements: { point: { radius: 2 } }
    }
});
</script>
{% endblock %}
