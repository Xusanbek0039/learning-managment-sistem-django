{% extends 'accounts/admin/base_admin.html' %}

{% block title %}To'lovlar - Admin{% endblock %}

{% block admin_content %}
<div class="top-bar">
    <h1 class="page-title"><i class="bi bi-credit-card me-2"></i>To'lovlar boshqaruvi</h1>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon green me-3"><i class="bi bi-check-circle"></i></div>
                <div>
                    <div class="stat-number">{% widthratio students|length 1 1 as total %}{% for s in students %}{% if s.payment_status and s.payment_status.is_paid %}{% with True as has_paid %}{% endwith %}{% endif %}{% endfor %}{{ students|length }}</div>
                    <div class="stat-label">Jami o'quvchilar</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon red me-3"><i class="bi bi-x-circle"></i></div>
                <div>
                    <div class="stat-number">{% for s in students %}{% if s.is_blocked %}{% with True as blocked %}{% endwith %}{% endif %}{% endfor %}{% for s in students %}{% if s.is_blocked %}1{% endif %}{% empty %}0{% endfor %}</div>
                    <div class="stat-label">Bloklangan</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card">
            <div class="d-flex align-items-center">
                <div class="stat-icon orange me-3"><i class="bi bi-calendar"></i></div>
                <div>
                    <div class="stat-number">{{ today.day }}</div>
                    <div class="stat-label">Bugungi sana</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Eslatma:</strong> Har oyning 5-sanasida to'lov eslatmasi, 10-sanasida esa to'lamaganlar avtomatik bloklanadi. Oyning 1-sanasida to'lov holati yangilanadi.
</div>

<div class="card">
    <div class="card-header">
        <i class="bi bi-list me-2"></i>O'quvchilar to'lov holati
    </div>
    <div class="card-body">
        {% if students %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>O'quvchi</th>
                        <th>Telefon</th>
                        <th class="text-center">To'lov</th>
                        <th class="text-center">Status</th>
                        <th>Oxirgi to'lov</th>
                        <th>Amal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>
                            <strong>{{ student.full_name }}</strong>
                            <br><small class="text-muted">@{{ student.username }}</small>
                        </td>
                        <td>{{ student.phone }}</td>
                        <td class="text-center">
                            {% if student.payment_status and student.payment_status.is_paid %}
                            <span class="badge bg-success"><i class="bi bi-check"></i> To'langan</span>
                            {% else %}
                            <span class="badge bg-danger"><i class="bi bi-x"></i> To'lanmagan</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if student.is_blocked %}
                            <span class="badge bg-danger">Bloklangan</span>
                            {% else %}
                            <span class="badge bg-success">Faol</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if student.payment_status and student.payment_status.last_payment_date %}
                            {{ student.payment_status.last_payment_date|date:"d.m.Y" }}
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not student.payment_status or not student.payment_status.is_paid %}
                            <a href="{% url 'admin_mark_paid' student.pk %}" class="btn btn-sm btn-success" title="To'landi deb belgilash">
                                <i class="bi bi-check-lg me-1"></i>To'landi
                            </a>
                            {% else %}
                            <span class="text-success"><i class="bi bi-check-circle"></i></span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3">O'quvchilar yo'q</h4>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
