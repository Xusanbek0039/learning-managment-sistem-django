{% extends 'accounts/admin/base_admin.html' %}

{% block title %}To'lovlar - Admin Panel | IT Creative{% endblock %}

{% block extra_css %}
<style>
:root{
    --card-bg: rgba(255,255,255,.75);
    --card-border: rgba(0,0,0,.08);
    --text-main: #111;
    --soft-bg: rgba(0,0,0,.05);
}
[data-bs-theme="dark"]{
    --card-bg: rgba(18,18,18,.8);
    --card-border: rgba(255,255,255,.08);
    --text-main: #f1f1f1;
    --soft-bg: rgba(255,255,255,.06);
}

/* ===== TOP BAR ===== */
.top-bar{
    display:flex;justify-content:space-between;align-items:center;
    flex-wrap:wrap;gap:12px;margin-bottom:20px;
}

/* ===== IOS CARD ===== */
.ios-card{
    background:var(--card-bg);
    backdrop-filter:blur(14px);
    border:1px solid var(--card-border);
    border-radius:22px;
    box-shadow:0 12px 35px rgba(0,0,0,.15);
}

/* ===== STAT CARDS ===== */
.stat-card{
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:20px;
    padding:18px;
    backdrop-filter:blur(12px);
    transition:.25s;
}
.stat-card:hover{
    transform:translateY(-4px);
    box-shadow:0 14px 30px rgba(0,0,0,.18);
}

.stat-icon{
    width:44px;height:44px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    color:#fff;font-size:1.2rem;
}
.green{background:linear-gradient(135deg,#198754,#157347);}
.red{background:linear-gradient(135deg,#dc3545,#b02a37);}
.orange{background:linear-gradient(135deg,#fd7e14,#e8590c);}

.stat-number{font-size:1.4rem;font-weight:700;color:var(--text-main);}
.stat-label{font-size:.85rem;opacity:.7}

/* ===== ALERT ===== */
.ios-alert{
    background:var(--card-bg);
    border:1px solid var(--card-border);
    border-radius:18px;
}

/* ===== TABLE ===== */
.table{color:var(--text-main);}
.table thead th{border-bottom:1px solid var(--card-border);font-weight:600;}
.table tbody tr:hover{background:var(--soft-bg);}

/* ===== MOBILE TABLE ===== */
@media(max-width:768px){
.table thead{display:none;}
.table tbody tr{
    display:block;border:1px solid var(--card-border);
    border-radius:14px;padding:12px;margin-bottom:12px;
    background:var(--soft-bg);
}
.table tbody td{
    display:flex;justify-content:space-between;
    padding:6px 0;border:none;
}
.table tbody td::before{
    content:attr(data-label);
    font-weight:600;opacity:.7;
}
}
</style>
{% endblock %}

{% block admin_content %}

<div class="top-bar">
    <h3 class="m-0"><i class="bi bi-credit-card me-2"></i>To'lovlar boshqaruvi</h3>
    <form method="post" action="{% url 'send_bulk_payment_reminders' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning rounded-pill" onclick="return confirm('Barcha to\'lanmagan o\'quvchilarga eslatma yuborilsinmi?')">
            <i class="bi bi-bell me-1"></i>Barchaga eslatma
        </button>
    </form>
</div>

<!-- ===== STATS ===== -->
<div class="row g-3 mb-4">

<div class="col-md-4">
<div class="stat-card h-100">
<div class="d-flex align-items-center">
<div class="stat-icon green me-3"><i class="bi bi-people"></i></div>
<div>
<div class="stat-number">{{ students|length }}</div>
<div class="stat-label">Jami o'quvchilar</div>
</div>
</div>
</div>
</div>

<div class="col-md-4">
<div class="stat-card h-100">
<div class="d-flex align-items-center">
<div class="stat-icon red me-3"><i class="bi bi-x-circle"></i></div>
<div>
<div class="stat-number">{{ blocked_students }}</div>
<div class="stat-label">Bloklangan</div>
</div>
</div>
</div>
</div>

<div class="col-md-4">
<div class="stat-card h-100">
<div class="d-flex align-items-center">
<div class="stat-icon orange me-3"><i class="bi bi-calendar"></i></div>
<div>
<div class="stat-number">{{ today|date:"d" }}</div>
<div class="stat-label">Bugungi sana</div>
</div>
</div>
</div>
</div>

</div>

<!-- ===== INFO ===== -->
<div class="ios-alert alert alert-info mb-4">
<i class="bi bi-info-circle me-2"></i>
<strong>Eslatma:</strong> Har oyning 5-sanasida eslatma, 10-sanasida bloklanadi.
</div>

<!-- ===== TABLE ===== -->
<div class="ios-card">

<div class="p-3 border-bottom" style="border-color:var(--card-border)!important;">
<i class="bi bi-list me-2"></i>O'quvchilar to'lov holati
</div>

<div class="p-3">

{% if students %}
<div class="table-responsive">
<table class="table align-middle mb-0">

<thead>
<tr>
<th>O'quvchi</th>
<th>Telefon</th>
<th class="text-center">To'lov</th>
<th class="text-center">Status</th>
<th>Oxirgi</th>
<th>Amal</th>
</tr>
</thead>

<tbody>
{% for student in students %}
<tr>

<td data-label="O'quvchi">
<strong>{{ student.full_name }}</strong>
<br><small class="text-muted">@{{ student.username }}</small>
</td>

<td data-label="Telefon">{{ student.phone }}</td>

<td data-label="To'lov" class="text-center">
{% if student.payment_status and student.payment_status.is_paid %}
<span class="badge bg-success">To'langan</span>
{% else %}
<span class="badge bg-danger">To'lanmagan</span>
{% endif %}
</td>

<td data-label="Status" class="text-center">
{% if student.is_blocked %}
<span class="badge bg-danger">Bloklangan</span>
{% else %}
<span class="badge bg-success">Faol</span>
{% endif %}
</td>

<td data-label="Oxirgi">
{% if student.payment_status and student.payment_status.last_payment_date %}
{{ student.payment_status.last_payment_date|date:"d.m.Y" }}
{% else %}
<span class="text-muted">â€”</span>
{% endif %}
</td>

<td data-label="Amal">
{% if not student.payment_status or not student.payment_status.is_paid %}
<div class="d-flex gap-1 flex-wrap">
<a href="{% url 'admin_mark_paid' student.pk %}" class="btn btn-sm btn-success rounded-pill">
<i class="bi bi-check-lg me-1"></i>To'landi
</a>
<a href="{% url 'send_payment_reminder' student.pk %}" class="btn btn-sm btn-warning rounded-pill" onclick="return confirm('{{ student.full_name }}ga eslatma yuborilsinmi?')">
<i class="bi bi-bell"></i>
</a>
</div>
{% else %}
<span class="text-success"><i class="bi bi-check-circle"></i></span>
{% endif %}
</td>

</tr>
{% endfor %}
</tbody>

</table>
</div>

{% else %}
<div class="text-center py-5 text-muted">
<i class="bi bi-people fs-1"></i>
<h5 class="mt-3">O'quvchilar yo'q</h5>
</div>
{% endif %}

</div>
</div>

{% endblock %}
