{% extends 'accounts/admin/base_admin.html' %}

{% block title %}Foydalanuvchilar - Admin Panel{% endblock %}

{% block extra_css %}
<meta name="keywords" content="Suyunov Husan, IT Creative, Django admin users iOS style dark light responsive">
<style>

/* ===== iOS Minimal Palette ===== */
:root{
    --bg:#f5f5f7;
    --card:#ffffff;
    --text:#111;
    --muted:#6b7280;
    --border:rgba(0,0,0,.08);
    --primary:#0a84ff;
    --success:#28a745;
    --danger:#dc3545;
    --warning:#f0ad4e;
}
@media (prefers-color-scheme: dark){
    :root{
        --bg:#0b0b0c;
        --card:#1c1c1e;
        --text:#f5f5f7;
        --muted:#9ca3af;
        --border:rgba(255,255,255,.08);
    }
}

/* ===== Layout ===== */
.admin-ios{
    background:var(--bg);
    min-height:100vh;
    padding:1rem;
    color:var(--text);
}

/* ===== Top ===== */
.page-title{
    font-size:1.4rem;
    font-weight:700;
    margin-bottom:1rem;
}

/* ===== Cards ===== */
.card{
    background:var(--card)!important;
    border-radius:14px;
    border:1px solid var(--border);
}
.card-header{
    background:transparent!important;
    border-bottom:1px solid var(--border);
    font-weight:600;
}

/* ===== Filters ===== */
.form-label{font-weight:600;color:var(--text);}
.form-select,.form-control{
    background:transparent;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:10px;
}
.form-select:focus,.form-control:focus{
    border-color:var(--primary);
    box-shadow:none;
}
.btn-primary{background:var(--primary);border:none;border-radius:10px;}
.btn-outline-secondary{border-radius:10px;border-color:var(--border);color:var(--text);}

/* ===== Table ===== */
.table{margin:0;color:var(--text);}
.table th{
    color:var(--muted);
    font-weight:600;
    border-bottom:1px solid var(--border);
}
.table td{border-top:1px solid var(--border);vertical-align:middle;}

/* ===== Avatars ===== */
.user-avatar-sm{
    width:36px;height:36px;border-radius:50%;object-fit:cover;
}
.user-avatar-placeholder{
    width:36px;height:36px;border-radius:50%;
    background:#adb5bd;color:white;font-weight:700;
    display:flex;align-items:center;justify-content:center;
}

/* ===== Online dot ===== */
.online-badge{
    display:inline-block;width:7px;height:7px;border-radius:50%;
    background:#28a745;margin-left:4px;
}

/* ===== Badges ===== */
.badge{border-radius:999px;padding:.35rem .6rem;}

/* ===== Action buttons ===== */
.action-btns .btn{border-radius:10px;}

/* ===== Mobile Responsive ===== */
@media(max-width:768px){
    table thead{display:none;}
    table tr{display:block;padding:1rem;border-bottom:1px solid var(--border);}
    table td{display:flex;justify-content:space-between;border:none;padding:.35rem 0;}
    table td::before{
        content:attr(data-label);
        font-weight:600;
        color:var(--muted);
    }
}

</style>
{% endblock %}

{% block admin_content %}
<div class="admin-ios">

<h1 class="page-title">
    <i class="bi bi-people me-1"></i>Foydalanuvchilar
</h1>

<!-- FILTERS -->
<div class="card mb-3">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Rol</label>
                <select name="role" class="form-select">
                    <option value="">Barchasi</option>
                    <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="teacher" {% if role_filter == 'teacher' %}selected{% endif %}>O‘qituvchi</option>
                    <option value="student" {% if role_filter == 'student' %}selected{% endif %}>O‘quvchi</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Yo‘nalish</label>
                <select name="profession" class="form-select">
                    <option value="">Barchasi</option>
                    {% for p in professions %}
                    <option value="{{ p.id }}" {% if profession_filter == p.id|stringformat:"i" %}selected{% endif %}>
                        {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select name="status" class="form-select">
                    <option value="">Barchasi</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Faol</option>
                    <option value="blocked" {% if status_filter == 'blocked' %}selected{% endif %}>Bloklangan</option>
                </select>
            </div>

            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-filter"></i>
                </button>
                <a href="{% url 'admin_users' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </form>
    </div>
</div>

<!-- LIST -->
<div class="card">
    <div class="card-header">
        Foydalanuvchilar ({{ users.count }})
    </div>

    <div class="card-body p-0">
    {% if users %}
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Foydalanuvchi</th>
                    <th>Telefon</th>
                    <th>Rol</th>
                    <th>Yo‘nalish</th>
                    <th class="text-center">Status</th>
                    <th>Faollik</th>
                    <th>Amallar</th>
                </tr>
            </thead>
            <tbody>

            {% for u in users %}
            <tr>
                <td data-label="#"> {{ forloop.counter }} </td>

                <td data-label="Foydalanuvchi">
                    <div class="d-flex align-items-center gap-2">
                        {% if u.photo %}
                        <img src="{{ u.photo.url }}" class="user-avatar-sm">
                        {% else %}
                        <div class="user-avatar-placeholder">{{ u.get_initials }}</div>
                        {% endif %}
                        <div>
                            <strong>{{ u.full_name }}</strong>
                            {% if u.is_online %}<span class="online-badge"></span>{% endif %}
                            <br><small class="text-muted">@{{ u.username }}</small>
                        </div>
                    </div>
                </td>

                <td data-label="Telefon">{{ u.phone }}</td>

                <td data-label="Rol">
                    <span class="badge
                        {% if u.role == 'admin' %}bg-danger
                        {% elif u.role == 'teacher' %}bg-success
                        {% else %}bg-primary{% endif %}">
                        {% if u.role == 'admin' %}Admin{% elif u.role == 'teacher' %}O‘qituvchi{% else %}O‘quvchi{% endif %}
                    </span>
                </td>

                <td data-label="Yo‘nalish">
                    {% if u.profession %}{{ u.profession.name }}{% else %}<span class="text-muted">—</span>{% endif %}
                </td>

                <td data-label="Status" class="text-center">
                    {% if u.is_blocked %}
                    <span class="badge bg-danger">Bloklangan</span>
                    {% else %}
                    <span class="badge bg-success">Faol</span>
                    {% endif %}
                </td>

                <td data-label="Faollik">
                    {% if u.last_activity %}
                        {{ u.last_activity|timesince }} oldin
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>

                <td data-label="Amallar" class="action-btns">
                    <a href="{% url 'admin_user_view' u.pk %}" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-eye"></i>
                    </a>
                    <a href="{% url 'admin_user_edit' u.pk %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    {% if not u.is_admin %}
                    <a href="{% url 'admin_user_block' u.pk %}" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-{% if u.is_blocked %}unlock{% else %}lock{% endif %}"></i>
                    </a>
                    <a href="{% url 'admin_user_delete' u.pk %}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash"></i>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}

            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-people" style="font-size:2.5rem;"></i>
        <p class="mt-2 mb-0">Foydalanuvchilar topilmadi</p>
    </div>
    {% endif %}
    </div>
</div>

</div>
{% endblock %}
