{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}{{ session.title }} - AI Yordamchi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
    :root {
        --chat-bg: #0d0d0d;
        --sidebar-bg: #171717;
        --message-user-bg: #2f2f2f;
        --border-color: #2f2f2f;
        --text-primary: #ececec;
        --text-secondary: #9b9b9b;
        --accent-color: #10a37f;
        --code-bg: #1e1e1e;
    }
    
    [data-bs-theme="light"] {
        --chat-bg: #ffffff;
        --sidebar-bg: #f7f7f8;
        --message-user-bg: #f7f7f8;
        --border-color: #e5e5e5;
        --text-primary: #1a1a1a;
        --text-secondary: #6b6b6b;
        --code-bg: #f6f8fa;
    }
    
    body { background: var(--chat-bg) !important; }
    
    .chat-wrapper {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 70px);
    }
    
    .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.5rem;
        background: var(--sidebar-bg);
        border-bottom: 1px solid var(--border-color);
    }
    
    .chat-title {
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
    }
    
    .ai-dot {
        width: 8px;
        height: 8px;
        background: var(--accent-color);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .header-actions {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .coin-badge {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #000;
        padding: 0.4rem 0.9rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.8rem;
    }
    
    .btn-header {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.4rem 0.75rem;
        border-radius: 8px;
        transition: all 0.2s;
        text-decoration: none;
    }
    
    .btn-header:hover {
        background: var(--message-user-bg);
        color: var(--text-primary);
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }
    
    .messages-container::-webkit-scrollbar { width: 8px; }
    .messages-container::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }
    
    .message {
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .message:last-child { border-bottom: none; }
    
    .message-inner {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 1.5rem;
        display: flex;
        gap: 1rem;
    }
    
    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        flex-shrink: 0;
        font-size: 0.85rem;
    }
    
    .message.user .message-avatar {
        background: linear-gradient(135deg, #5436DA, #764ba2);
        color: white;
    }
    
    .message.assistant .message-avatar {
        background: var(--accent-color);
        color: white;
    }
    
    .message-body {
        flex: 1;
        min-width: 0;
    }
    
    .message-role {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }
    
    .message-content {
        color: var(--text-primary);
        line-height: 1.7;
        font-size: 1rem;
    }
    
    .message.user .message-content {
        white-space: pre-wrap;
    }
    
    /* Markdown */
    .markdown-body { color: var(--text-primary); }
    .markdown-body p { margin-bottom: 1rem; }
    .markdown-body p:last-child { margin-bottom: 0; }
    
    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
        color: var(--text-primary);
        margin: 1.5rem 0 1rem;
        font-weight: 600;
    }
    
    .markdown-body ul, .markdown-body ol {
        margin: 1rem 0;
        padding-left: 1.5rem;
    }
    
    .markdown-body li { margin: 0.4rem 0; }
    
    .markdown-body a {
        color: #58a6ff;
        text-decoration: none;
    }
    
    .markdown-body a:hover { text-decoration: underline; }
    
    .markdown-body strong { font-weight: 600; }
    
    /* Code Blocks */
    .code-block-wrapper {
        position: relative;
        margin: 1rem 0;
        border-radius: 10px;
        overflow: hidden;
        background: #0d1117;
        border: 1px solid #30363d;
    }
    
    .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 16px;
        background: #161b22;
        border-bottom: 1px solid #30363d;
    }
    
    .code-lang {
        font-size: 12px;
        color: #8b949e;
        font-weight: 500;
    }
    
    .copy-btn {
        background: transparent;
        border: none;
        color: #8b949e;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 6px;
        transition: all 0.2s;
    }
    
    .copy-btn:hover {
        background: #30363d;
        color: #c9d1d9;
    }
    
    .copy-btn.copied { color: #3fb950; }
    
    .markdown-body pre {
        margin: 0;
        padding: 16px;
        overflow-x: auto;
        background: transparent !important;
    }
    
    .markdown-body pre code {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 14px;
        line-height: 1.5;
        color: #c9d1d9;
        background: transparent !important;
    }
    
    .markdown-body p code, .markdown-body li code {
        background: #30363d;
        padding: 3px 8px;
        border-radius: 6px;
        font-family: 'Consolas', monospace;
        font-size: 13px;
        color: #ff7b72;
    }
    
    [data-bs-theme="light"] .markdown-body p code,
    [data-bs-theme="light"] .markdown-body li code {
        background: #eff1f3;
        color: #cf222e;
    }
    
    .markdown-body blockquote {
        border-left: 3px solid var(--accent-color);
        margin: 1rem 0;
        padding: 0.5rem 1rem;
        background: rgba(16, 163, 127, 0.1);
    }
    
    .message-image {
        max-width: 350px;
        border-radius: 10px;
        margin-top: 1rem;
        border: 1px solid var(--border-color);
    }
    
    .message-time {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-top: 0.75rem;
    }
    
    .empty-chat {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-secondary);
        text-align: center;
        padding: 2rem;
    }
    
    .ai-logo {
        width: 70px;
        height: 70px;
        background: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1.5rem;
    }
    
    .ai-logo i { font-size: 2rem; color: white; }
    
    .empty-chat h4 {
        color: var(--text-primary);
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .chat-input-container {
        padding: 1rem 1.5rem 1.5rem;
        background: var(--chat-bg);
        border-top: 1px solid var(--border-color);
    }
    
    .input-wrapper { max-width: 800px; margin: 0 auto; }
    
    .chat-form {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        background: var(--sidebar-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 0.75rem;
        transition: border-color 0.2s;
    }
    
    .chat-form:focus-within { border-color: var(--accent-color); }
    
    .input-group-wrapper { flex: 1; }
    
    .chat-input {
        width: 100%;
        padding: 0.5rem;
        border: none;
        background: transparent;
        color: var(--text-primary);
        font-size: 1rem;
        resize: none;
        min-height: 24px;
        max-height: 200px;
        line-height: 1.5;
    }
    
    .chat-input::placeholder { color: var(--text-secondary); }
    .chat-input:focus { outline: none; }
    
    .preview-container { margin-top: 0.5rem; display: flex; align-items: center; }
    
    .image-preview {
        max-width: 100px;
        max-height: 70px;
        border-radius: 8px;
        display: none;
    }
    
    .remove-image {
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        cursor: pointer;
        display: none;
        margin-left: 8px;
    }
    
    .form-actions { display: flex; gap: 0.5rem; }
    
    .btn-attach, .btn-send {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-attach {
        background: transparent;
        color: var(--text-secondary);
    }
    
    .btn-attach:hover {
        background: var(--message-user-bg);
        color: var(--text-primary);
    }
    
    .file-input-wrapper { position: relative; }
    
    .file-input-wrapper input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        top: 0;
        left: 0;
    }
    
    .btn-send {
        background: var(--accent-color);
        color: white;
    }
    
    .btn-send:hover { opacity: 0.9; }
    
    .btn-send:disabled {
        background: var(--border-color);
        color: var(--text-secondary);
        cursor: not-allowed;
    }
    
    .alert-warning-custom {
        background: rgba(251, 191, 36, 0.1);
        border: 1px solid rgba(251, 191, 36, 0.3);
        color: #fbbf24;
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
    }
    
    .modal-modern .modal-content {
        background: var(--sidebar-bg);
        border: 1px solid var(--border-color);
        border-radius: 16px;
    }
    
    .modal-modern .modal-body {
        padding: 2rem;
        text-align: center;
        color: var(--text-secondary);
    }
    
    .modal-modern .modal-footer {
        border-top: 1px solid var(--border-color);
        padding: 1rem;
        gap: 0.75rem;
    }
    
    .modal-icon-danger {
        width: 60px;
        height: 60px;
        background: rgba(239, 68, 68, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }
    
    .modal-icon-danger i { font-size: 1.5rem; color: #ef4444; }
    
    .btn-modal-cancel {
        background: var(--message-user-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 0.6rem 1.5rem;
        border-radius: 10px;
    }
    
    .btn-modal-danger {
        background: #ef4444;
        border: none;
        color: white;
        padding: 0.6rem 1.5rem;
        border-radius: 10px;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
        padding: 4px;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.6); opacity: 0.6; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    @media (max-width: 768px) {
        .message-inner { padding: 0 1rem; }
        .chat-header { padding: 0.75rem 1rem; }
        .chat-input-container { padding: 1rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-header">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'ai_yordamchi:chat_home' %}" class="btn-header">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h2 class="chat-title">
                <span class="ai-dot"></span>
                {{ session.title|truncatechars:30 }}
            </h2>
        </div>
        <div class="header-actions">
            <div class="coin-badge">
                <i class="bi bi-coin me-1"></i>{{ user_coins }}
            </div>
            <button type="button" class="btn-header" data-bs-toggle="modal" data-bs-target="#clearModal">
                <i class="bi bi-trash3"></i>
            </button>
        </div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        {% if chat_messages %}
            {% for msg in chat_messages %}
            <div class="message {{ msg.role }}">
                <div class="message-inner">
                    <div class="message-avatar">
                        {% if msg.role == 'user' %}
                            {{ user.first_name.0|upper }}
                        {% else %}
                            <i class="bi bi-robot"></i>
                        {% endif %}
                    </div>
                    <div class="message-body">
                        <div class="message-role">
                            {% if msg.role == 'user' %}
                                {{ user.first_name }} {{ user.last_name }}
                            {% else %}
                                AI Yordamchi
                            {% endif %}
                        </div>
                        <div class="message-content">
                            {% if msg.role == 'assistant' %}
                                <div class="markdown-body" id="ai-msg-{{ forloop.counter }}"></div>
                                <script type="text/plain" id="ai-content-{{ forloop.counter }}">{{ msg.content }}</script>
                            {% else %}
                                {{ msg.content }}
                            {% endif %}
                        </div>
                        {% if msg.image %}
                        <img src="{{ msg.image.url }}" alt="Rasm" class="message-image">
                        {% endif %}
                        <div class="message-time">
                            {{ msg.created_at|date:"H:i" }}
                            {% if msg.coins_spent %} Â· -{{ msg.coins_spent }} coin{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-chat">
                <div class="ai-logo">
                    <i class="bi bi-robot"></i>
                </div>
                <h4>AI Yordamchi</h4>
                <p>Dasturlash, matematika, tarix va boshqa mavzularda yordam beraman</p>
                <p class="mt-2"><small>Har bir xabar uchun 1 coin</small></p>
            </div>
        {% endif %}
    </div>
    
    <div class="chat-input-container">
        <div class="input-wrapper">
            {% if user_coins < 1 %}
            <div class="alert-warning-custom">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Coin yetarli emas. Kamida 1 coin kerak.
            </div>
            {% else %}
            <form action="{% url 'ai_yordamchi:send_message' pk=session.pk %}" method="post" enctype="multipart/form-data" class="chat-form" id="chatForm">
                {% csrf_token %}
                <div class="input-group-wrapper">
                    <textarea name="content" class="chat-input" placeholder="Xabar yozing..." rows="1" id="chatInput"></textarea>
                    <div class="preview-container">
                        <img id="imagePreview" class="image-preview" alt="Preview">
                        <button type="button" id="removeImage" class="remove-image" onclick="removeImagePreview()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
                <div class="form-actions">
                    <div class="file-input-wrapper">
                        <button type="button" class="btn-attach" title="Rasm yuklash">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <input type="file" name="image" accept="image/*" id="imageInput" onchange="previewImage(this)">
                    </div>
                    <button type="submit" class="btn-send" id="sendBtn">
                        <i class="bi bi-arrow-up"></i>
                    </button>
                </div>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<div class="modal fade modal-modern" id="clearModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-body">
                <div class="modal-icon-danger">
                    <i class="bi bi-trash3"></i>
                </div>
                <h5 class="mb-2" style="color: var(--text-primary)">Tarixni tozalash</h5>
                <p class="mb-0">Barcha xabarlar o'chiriladi.</p>
            </div>
            <div class="modal-footer justify-content-center border-0">
                <button type="button" class="btn btn-modal-cancel" data-bs-dismiss="modal">Bekor</button>
                <form action="{% url 'ai_yordamchi:clear_history' pk=session.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-modal-danger">O'chirish</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// Custom renderer
const renderer = new marked.Renderer();

renderer.code = function(code, lang) {
    const language = lang || 'plaintext';
    let highlighted;
    try {
        highlighted = hljs.highlight(code, { language: hljs.getLanguage(language) ? language : 'plaintext' }).value;
    } catch(e) {
        highlighted = code;
    }
    
    const escapedCode = code.replace(/`/g, '\\`').replace(/\$/g, '\\$');
    
    return `<div class="code-block-wrapper">
        <div class="code-header">
            <span class="code-lang">${language}</span>
            <button class="copy-btn" onclick="copyCode(this, \`${escapedCode}\`)">
                <i class="bi bi-clipboard"></i> Nusxalash
            </button>
        </div>
        <pre><code class="hljs">${highlighted}</code></pre>
    </div>`;
};

marked.setOptions({
    renderer: renderer,
    breaks: true,
    gfm: true,
    headerIds: false,
    mangle: false
});

// Copy function
function copyCode(btn, code) {
    const text = code.replace(/\\`/g, '`').replace(/\\\$/g, '$');
    navigator.clipboard.writeText(text).then(() => {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="bi bi-check2"></i> Nusxalandi!';
        setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="bi bi-clipboard"></i> Nusxalash';
        }, 2000);
    });
}

// Render AI messages from script tags (no escaping)
document.querySelectorAll('script[type="text/plain"][id^="ai-content-"]').forEach(script => {
    const id = script.id.replace('ai-content-', '');
    const target = document.getElementById('ai-msg-' + id);
    if (target && script.textContent) {
        target.innerHTML = marked.parse(script.textContent);
    }
});

// Auto-scroll
const container = document.getElementById('messagesContainer');
if (container) container.scrollTop = container.scrollHeight;

// Textarea
const textarea = document.getElementById('chatInput');
const form = document.getElementById('chatForm');
const sendBtn = document.getElementById('sendBtn');

if (textarea) {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (this.value.trim()) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
                form.submit();
            }
        }
    });
    
    textarea.focus();
}

// Image preview
function previewImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('removeImage').style.display = 'flex';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function removeImagePreview() {
    document.getElementById('imageInput').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('removeImage').style.display = 'none';
}
</script>
{% endblock %}
